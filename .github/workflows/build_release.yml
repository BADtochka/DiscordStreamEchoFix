name: Semantic Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Get last tag
      id: get_last_tag
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
        echo "Last tag: $LAST_TAG"
    
    - name: Analyze commits
      id: analyze_commits
      run: |
        LAST_TAG="${{ steps.get_last_tag.outputs.last_tag }}"
        
        if [ "$LAST_TAG" = "v0.0.0" ]; then
          COMMITS=$(git log --oneline --format=%s)
        else
          COMMITS=$(git log "$LAST_TAG..HEAD" --oneline --format=%s)
        fi
        
        MAJOR_COUNT=$(echo "$COMMITS" | grep -i "BREAKING CHANGE\|!" | wc -l)
        FEAT_COUNT=$(echo "$COMMITS" | grep -i "^feat\|^feature" | wc -l)
        FIX_COUNT=$(echo "$COMMITS" | grep -i "^fix\|^bugfix" | wc -l)
        
        if [ $MAJOR_COUNT -gt 0 ]; then
          BUMP="major"
        elif [ $FEAT_COUNT -gt 0 ]; then
          BUMP="minor"
        elif [ $FIX_COUNT -gt 0 ]; then
          BUMP="patch"
        else
          BUMP="none"
        fi
        
        echo "bump_type=$BUMP" >> $GITHUB_OUTPUT

  build:
    runs-on: windows-latest
    needs: semantic-release
    if: needs.semantic-release.outputs.bump_type != 'none'
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Get project name
      id: project_name
      run: |
        # Get csproj filename without extension
        $PROJECT = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        $PROJECT_NAME = [System.IO.Path]::GetFileNameWithoutExtension($PROJECT.Name)
        echo "project_name=$PROJECT_NAME" >> $env:GITHUB_OUTPUT
        Write-Host "Project name: $PROJECT_NAME"
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Calculate new version
      id: calc_version
      run: |
        $LAST_TAG="${{ needs.semantic-release.outputs.last_tag }}"
        $BUMP="${{ needs.semantic-release.outputs.bump_type }}"
        
        $VERSION = $LAST_TAG -replace '^v', ''
        $PARTS = $VERSION -split '\.'
        
        switch ($BUMP) {
          "major" { 
            $PARTS[0] = [int]$PARTS[0] + 1
            $PARTS[1] = 0
            $PARTS[2] = 0
          }
          "minor" { 
            $PARTS[1] = [int]$PARTS[1] + 1
            $PARTS[2] = 0
          }
          "patch" { 
            $PARTS[2] = [int]$PARTS[2] + 1
          }
        }
        
        $NEW_VERSION = "$($PARTS[0]).$($PARTS[1]).$($PARTS[2])"
        echo "new_version=$NEW_VERSION" >> $env:GITHUB_OUTPUT
        Write-Host "New version: $NEW_VERSION"
    
    - name: Update version in csproj
      run: |
        $PROJECT = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        $VERSION = "${{ steps.calc_version.outputs.new_version }}"
        
        $CONTENT = Get-Content $PROJECT.FullName -Raw
        $CONTENT = $CONTENT -replace '<Version>[^<]*</Version>', "<Version>$VERSION</Version>"
        $CONTENT = $CONTENT -replace '<AssemblyVersion>[^<]*</AssemblyVersion>', "<AssemblyVersion>$VERSION.0</AssemblyVersion>"
        $CONTENT = $CONTENT -replace '<FileVersion>[^<]*</FileVersion>', "<FileVersion>$VERSION.0</FileVersion>"
        
        Set-Content -Path $PROJECT.FullName -Value $CONTENT
    
    - name: Build and publish
      run: |
        # Build
        dotnet build -c Release
        
        # Publish single file
        dotnet publish -c Release `
          -r win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:DebugType=None `
          -p:DebugSymbols=false `
          -o ./publish
        
        # Check what was created
        Write-Host "Files in publish directory:"
        Get-ChildItem ./publish -Recurse | ForEach-Object { Write-Host "  $($_.Name)" }
        
        # Verify executable exists
        $EXE_NAME = "${{ steps.project_name.outputs.project_name }}.exe"
        if (Test-Path "./publish/$EXE_NAME") {
          Write-Host "✅ Executable '$EXE_NAME' created successfully"
        } else {
          Write-Error "❌ Executable '$EXE_NAME' not found!"
          exit 1
        }
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.calc_version.outputs.new_version }}
        name: Release v${{ steps.calc_version.outputs.new_version }}
        body: |
          Automated semantic release
          
          Version: v${{ steps.calc_version.outputs.new_version }}
          
          Download the executable below and run it.
        files: |
          ./publish/${{ steps.project_name.outputs.project_name }}.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
