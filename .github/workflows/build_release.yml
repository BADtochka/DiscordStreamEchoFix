name: Semantic Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Find project file
      id: find_project
      run: |
        # Find .csproj file in repository
        PROJECT_FILE=$(find . -name "*.csproj" -type f | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "No .csproj file found!"
          exit 1
        fi
        echo "project_file=$PROJECT_FILE" >> $GITHUB_OUTPUT
        echo "Found project file: $PROJECT_FILE"
    
    - name: Get last tag
      id: get_last_tag
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
        echo "Last tag: $LAST_TAG"
    
    - name: Analyze commits
      id: analyze_commits
      run: |
        LAST_TAG="${{ steps.get_last_tag.outputs.last_tag }}"
        
        if [ "$LAST_TAG" = "v0.0.0" ]; then
          COMMITS=$(git log --oneline --format=%s)
        else
          COMMITS=$(git log "$LAST_TAG..HEAD" --oneline --format=%s)
        fi
        
        MAJOR_COUNT=$(echo "$COMMITS" | grep -i "BREAKING CHANGE\|!" | wc -l)
        FEAT_COUNT=$(echo "$COMMITS" | grep -i "^feat\|^feature\|^feat(\|^feat:" | wc -l)
        FIX_COUNT=$(echo "$COMMITS" | grep -i "^fix\|^bugfix\|^fix(\|^fix:" | wc -l)
        
        if [ $MAJOR_COUNT -gt 0 ]; then
          BUMP="major"
        elif [ $FEAT_COUNT -gt 0 ]; then
          BUMP="minor"
        elif [ $FIX_COUNT -gt 0 ]; then
          BUMP="patch"
        else
          BUMP="none"
        fi
        
        echo "bump_type=$BUMP" >> $GITHUB_OUTPUT
        echo "new_version_calc=$MAJOR_COUNT.$FEAT_COUNT.$FIX_COUNT" >> $GITHUB_OUTPUT

  build:
    runs-on: windows-latest
    needs: semantic-release
    if: needs.semantic-release.outputs.bump_type != 'none'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Find project file (Windows)
      id: find_project_win
      run: |
        # Find .csproj file
        $PROJECT_FILE = Get-ChildItem -Recurse -Filter "*.csproj" | Select-Object -First 1 -ExpandProperty FullName
        if (-not $PROJECT_FILE) {
          Write-Error "No .csproj file found!"
          exit 1
        }
        Write-Host "project_file=$PROJECT_FILE"
        echo "project_file=$PROJECT_FILE" >> $env:GITHUB_OUTPUT
        echo "project_dir=$(Split-Path -Path $PROJECT_FILE -Parent)" >> $env:GITHUB_OUTPUT
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Calculate new version
      id: calc_version
      run: |
        $LAST_TAG="${{ needs.semantic-release.outputs.last_tag }}"
        $BUMP="${{ needs.semantic-release.outputs.bump_type }}"
        
        $VERSION = $LAST_TAG -replace '^v', ''
        $PARTS = $VERSION -split '\.'
        
        switch ($BUMP) {
          "major" { 
            $PARTS[0] = [int]$PARTS[0] + 1
            $PARTS[1] = 0
            $PARTS[2] = 0
          }
          "minor" { 
            $PARTS[1] = [int]$PARTS[1] + 1
            $PARTS[2] = 0
          }
          "patch" { 
            $PARTS[2] = [int]$PARTS[2] + 1
          }
        }
        
        $NEW_VERSION = "$($PARTS[0]).$($PARTS[1]).$($PARTS[2])"
        echo "new_version=$NEW_VERSION" >> $env:GITHUB_OUTPUT
        Write-Host "New version: $NEW_VERSION ($BUMP bump)"
    
    - name: Update project version
      run: |
        $PROJECT_FILE="${{ steps.find_project_win.outputs.project_file }}"
        $VERSION="${{ steps.calc_version.outputs.new_version }}"
        
        Write-Host "Updating $PROJECT_FILE to version $VERSION"
        
        $CONTENT = Get-Content $PROJECT_FILE -Raw
        
        # Update Version tag
        $CONTENT = $CONTENT -replace '<Version>[^<]*</Version>', "<Version>$VERSION</Version>"
        # Update AssemblyVersion tag  
        $CONTENT = $CONTENT -replace '<AssemblyVersion>[^<]*</AssemblyVersion>', "<AssemblyVersion>$VERSION.0</AssemblyVersion>"
        # Update FileVersion tag
        $CONTENT = $CONTENT -replace '<FileVersion>[^<]*</FileVersion>', "<FileVersion>$VERSION.0</FileVersion>"
        
        Set-Content -Path $PROJECT_FILE -Value $CONTENT
        
        # Verify
        Write-Host "Updated content:"
        Select-String -Path $PROJECT_FILE -Pattern "Version"
    
    - name: Build
      run: |
        $PROJECT_DIR="${{ steps.find_project_win.outputs.project_dir }}"
        cd "$PROJECT_DIR"
        dotnet build -c Release
    
    - name: Publish single file
      run: |
        $PROJECT_DIR="${{ steps.find_project_win.outputs.project_dir }}"
        cd "$PROJECT_DIR"
        dotnet publish -c Release `
          -r win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:DebugType=None `
          -o ./publish
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.calc_version.outputs.new_version }}
        name: Discord Audio Guard v${{ steps.calc_version.outputs.new_version }}
        body: |
          ## v${{ steps.calc_version.outputs.new_version }}
          
          **Automatic semantic release**
          
          ### Changes Since Last Release:
          ${{ needs.semantic-release.outputs.new_version_calc }}
          
          ### Download
          Single executable file ready to use.
          
          ### Usage
          1. Run `DiscordAudioGuardTray.exe`
          2. Configure devices in system tray settings
          3. Discord audio will be muted on unselected devices
        draft: false
        files: |
          ${{ steps.find_project_win.outputs.project_dir }}/publish/DiscordAudioGuardTray.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
