name: Semantic Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Analyze commits and calculate version
      id: version
      shell: pwsh
      run: |
        # Get last semantic version tag
        $LAST_TAG = git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | Select-Object -First 1
        if (-not $LAST_TAG) { $LAST_TAG = "v0.0.0" }
        Write-Host "Last tag: $LAST_TAG"
        
        # Get commits since last tag
        $COMMITS = if ($LAST_TAG -eq "v0.0.0") {
          git log --oneline --format=%s
        } else {
          git log "$LAST_TAG..HEAD" --oneline --format=%s
        }
        
        # Count commit types
        $MAJOR = ($COMMITS | Select-String -Pattern "BREAKING CHANGE|^.*!:" -CaseSensitive:$false).Count
        $FEAT = ($COMMITS | Select-String -Pattern "^feat|^feature" -CaseSensitive:$false).Count
        $FIX = ($COMMITS | Select-String -Pattern "^fix|^bug" -CaseSensitive:$false).Count
        
        Write-Host "Breaking: $MAJOR, Features: $FEAT, Fixes: $FIX"
        
        # Determine version bump
        $BUMP = if ($MAJOR -gt 0) { "major" } 
                elseif ($FEAT -gt 0) { "minor" } 
                elseif ($FIX -gt 0) { "patch" } 
                else { "none" }
        
        if ($BUMP -eq "none") {
          Write-Host "No version bump needed"
          echo "should_release=false" >> $env:GITHUB_OUTPUT
          exit 0
        }
        
        # Calculate new version
        $VERSION = $LAST_TAG -replace '^v', ''
        $PARTS = $VERSION -split '\.'
        $MAJ = [int]$PARTS[0]
        $MIN = [int]$PARTS[1]
        $PAT = [int]$PARTS[2]
        
        switch ($BUMP) {
          "major" { $MAJ++; $MIN = 0; $PAT = 0 }
          "minor" { $MIN++; $PAT = 0 }
          "patch" { $PAT++ }
        }
        
        $NEW_VERSION = "$MAJ.$MIN.$PAT"
        $TAG = "v$NEW_VERSION"
        
        Write-Host "New version: $TAG"
        
        echo "should_release=true" >> $env:GITHUB_OUTPUT
        echo "version=$NEW_VERSION" >> $env:GITHUB_OUTPUT
        echo "tag=$TAG" >> $env:GITHUB_OUTPUT
        echo "major_count=$MAJOR" >> $env:GITHUB_OUTPUT
        echo "feat_count=$FEAT" >> $env:GITHUB_OUTPUT
        echo "fix_count=$FIX" >> $env:GITHUB_OUTPUT
    
    - name: Get project name
      if: steps.version.outputs.should_release == 'true'
      id: project
      shell: pwsh
      run: |
        $PROJECT = (Get-ChildItem -Filter "*.csproj" | Select-Object -First 1).BaseName
        echo "name=$PROJECT" >> $env:GITHUB_OUTPUT
        Write-Host "Project: $PROJECT"
    
    - name: Setup .NET
      if: steps.version.outputs.should_release == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Update project version
      if: steps.version.outputs.should_release == 'true'
      shell: pwsh
      run: |
        $CSPROJ = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        $VERSION = "${{ steps.version.outputs.version }}"
        
        $XML = [xml](Get-Content $CSPROJ.FullName)
        $PropertyGroup = $XML.Project.PropertyGroup | Select-Object -First 1
        
        if (-not $PropertyGroup.Version) {
          $PropertyGroup.AppendChild($XML.CreateElement("Version")) | Out-Null
        }
        $PropertyGroup.Version = $VERSION
        
        $XML.Save($CSPROJ.FullName)
        Write-Host "Updated version to $VERSION"
    
    - name: Build and publish
      if: steps.version.outputs.should_release == 'true'
      shell: pwsh
      run: |
        dotnet publish -c Release `
          -r win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:DebugType=None `
          -p:DebugSymbols=false `
          -o ./publish
        
        $EXE = "./publish/${{ steps.project.outputs.name }}.exe"
        if (-not (Test-Path $EXE)) {
          Write-Error "Executable not found: $EXE"
          exit 1
        }
        Write-Host "‚úÖ Build successful"
    
    - name: Create tag and release
      if: steps.version.outputs.should_release == 'true'
      shell: pwsh
      run: |
        $TAG = "${{ steps.version.outputs.tag }}"
        
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        git tag -a $TAG -m "Release $TAG"
        git push origin $TAG
        
        Write-Host "‚úÖ Tag $TAG created"
    
    - name: Create GitHub Release
      if: steps.version.outputs.should_release == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        body: |
          # ${{ steps.project.outputs.name }} ${{ steps.version.outputs.version }}
          
          Automated semantic release.
          
          ## Changes
          - üí• Breaking: ${{ steps.version.outputs.major_count }}
          - ‚ú® Features: ${{ steps.version.outputs.feat_count }}
          - üêõ Fixes: ${{ steps.version.outputs.fix_count }}
          
          ## Installation
          Download and run `${{ steps.project.outputs.name }}.exe`
        draft: false
        files: ./publish/${{ steps.project.outputs.name }}.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
