name: Semantic Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Get last tag
      id: get_last_tag
      run: |
        # Get the latest semantic version tag
        LAST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1)
        if [ -z "$LAST_TAG" ]; then
          LAST_TAG="v0.0.0"
        fi
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
        echo "Last tag: $LAST_TAG"
    
    - name: Analyze commits since last tag
      id: analyze_commits
      run: |
        LAST_TAG="${{ steps.get_last_tag.outputs.last_tag }}"
        echo "Analyzing commits since: $LAST_TAG"
        
        # Get commit messages since last tag
        if [ "$LAST_TAG" = "v0.0.0" ]; then
          COMMITS=$(git log --oneline --format=%s)
        else
          COMMITS=$(git log "$LAST_TAG..HEAD" --oneline --format=%s)
        fi
        
        echo "Found $(echo "$COMMITS" | wc -l) commits since last tag"
        
        # Count commit types
        MAJOR_COUNT=$(echo "$COMMITS" | grep -E -i "BREAKING CHANGE|^.*!:" | wc -l)
        FEAT_COUNT=$(echo "$COMMITS" | grep -E -i "^feat|^feature" | wc -l)
        FIX_COUNT=$(echo "$COMMITS" | grep -E -i "^fix|^bug" | wc -l)
        
        echo "Major changes: $MAJOR_COUNT"
        echo "Features: $FEAT_COUNT"
        echo "Fixes: $FIX_COUNT"
        
        # Determine bump type
        if [ $MAJOR_COUNT -gt 0 ]; then
          BUMP="major"
        elif [ $FEAT_COUNT -gt 0 ]; then
          BUMP="minor"
        elif [ $FIX_COUNT -gt 0 ]; then
          BUMP="patch"
        else
          BUMP="none"
        fi
        
        echo "bump_type=$BUMP" >> $GITHUB_OUTPUT
        echo "Version bump needed: $BUMP"

  build:
    runs-on: windows-latest
    needs: semantic-release
    if: needs.semantic-release.outputs.bump_type != 'none'
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Get project name
      id: project_name
      run: |
        $PROJECT = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        $PROJECT_NAME = [System.IO.Path]::GetFileNameWithoutExtension($PROJECT.Name)
        echo "project_name=$PROJECT_NAME" >> $env:GITHUB_OUTPUT
        Write-Host "Project name: $PROJECT_NAME"
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Calculate new version
      id: calc_version
      run: |
        $LAST_TAG = "${{ needs.semantic-release.outputs.last_tag }}"
        $BUMP = "${{ needs.semantic-release.outputs.bump_type }}"
        
        Write-Host "Last tag: $LAST_TAG"
        Write-Host "Bump type: $BUMP"
        
        # Extract version numbers
        $VERSION_NUMBERS = $LAST_TAG -replace '^v', ''
        $PARTS = $VERSION_NUMBERS -split '\.'
        
        # Convert to integers
        $MAJOR = [int]$PARTS[0]
        $MINOR = [int]$PARTS[1]
        $PATCH = [int]$PARTS[2]
        
        # Apply bump
        switch ($BUMP) {
          "major" { 
            $MAJOR++
            $MINOR = 0
            $PATCH = 0
          }
          "minor" { 
            $MINOR++
            $PATCH = 0
          }
          "patch" { 
            $PATCH++
          }
        }
        
        $NEW_VERSION = "$MAJOR.$MINOR.$PATCH"
        $TAG = "v$NEW_VERSION"
        
        Write-Host "New version: $NEW_VERSION"
        Write-Host "New tag: $TAG"
        
        # Set outputs
        echo "new_version=$NEW_VERSION" >> $env:GITHUB_OUTPUT
        echo "tag=$TAG" >> $env:GITHUB_OUTPUT
    
    - name: Check if tag already exists
      id: check_tag
      run: |
        $TAG = "${{ steps.calc_version.outputs.tag }}"
        Write-Host "Checking if tag exists: $TAG"
        
        # Check local tags
        $LOCAL_TAG = git tag -l $TAG
        if ($LOCAL_TAG) {
          Write-Host "Tag $TAG already exists locally"
          echo "tag_exists=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "Tag $TAG does not exist locally"
          echo "tag_exists=false" >> $env:GITHUB_OUTPUT
        }
    
    - name: Update version in csproj
      if: steps.check_tag.outputs.tag_exists == 'false'
      run: |
        $PROJECT = Get-ChildItem -Filter "*.csproj" | Select-Object -First 1
        $VERSION = "${{ steps.calc_version.outputs.new_version }}"
        
        Write-Host "Updating $($PROJECT.Name) to version $VERSION"
        
        $CONTENT = Get-Content $PROJECT.FullName -Raw
        $CONTENT = $CONTENT -replace '<Version>[^<]*</Version>', "<Version>$VERSION</Version>"
        $CONTENT = $CONTENT -replace '<AssemblyVersion>[^<]*</AssemblyVersion>', "<AssemblyVersion>$VERSION</AssemblyVersion>"
        $CONTENT = $CONTENT -replace '<FileVersion>[^<]*</FileVersion>', "<FileVersion>$VERSION</FileVersion>"
        
        Set-Content -Path $PROJECT.FullName -Value $CONTENT -Encoding UTF8
    
    - name: Build and publish
      if: steps.check_tag.outputs.tag_exists == 'false'
      run: |
        dotnet build -c Release
        
        dotnet publish -c Release `
          -r win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          -p:DebugType=None `
          -p:DebugSymbols=false `
          -o ./publish
        
        $EXE_NAME = "${{ steps.project_name.outputs.project_name }}.exe"
        $EXE_PATH = "./publish/$EXE_NAME"
        if (Test-Path $EXE_PATH) {
          Write-Host "✅ Executable created: $EXE_NAME"
        } else {
          Write-Error "❌ Executable not found"
          exit 1
        }
    
    - name: Create and push Git tag
      if: steps.check_tag.outputs.tag_exists == 'false'
      run: |
        $TAG = "${{ steps.calc_version.outputs.tag }}"
        
        Write-Host "Creating tag: $TAG"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a $TAG -m "Release $TAG"
        git push origin $TAG
        
        Write-Host "✅ Tag $TAG created and pushed"
    
    - name: Skip existing tag
      if: steps.check_tag.outputs.tag_exists == 'true'
      run: |
        $TAG = "${{ steps.calc_version.outputs.tag }}"
        Write-Host "⚠️  Tag $TAG already exists. Skipping release creation."
        Write-Host "This usually means the commits don't require a new version bump."
    
    - name: Create GitHub Release
      if: steps.check_tag.outputs.tag_exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.calc_version.outputs.tag }}
        name: Release ${{ steps.calc_version.outputs.tag }}
        body: |
          # Discord Audio Guard ${{ steps.calc_version.outputs.new_version }}
          
          Automated semantic release.
          
          ## What's New
          - **Breaking changes**: ${{ needs.semantic-release.outputs.major_count || 0 }}
          - **Features**: ${{ needs.semantic-release.outputs.feat_count || 0 }}
          - **Fixes**: ${{ needs.semantic-release.outputs.fix_count || 0 }}
          
          ## Installation
          1. Download `${{ steps.project_name.outputs.project_name }}.exe`
          2. Run the executable
          3. Configure audio devices in system tray settings
          
          *Fixes Discord Go Live echo when streaming entire screen.*
        draft: false
        files: |
          ./publish/${{ steps.project_name.outputs.project_name }}.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
